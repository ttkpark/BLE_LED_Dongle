# BLE LED Dongle - Flutter 앱 연동 요구사항 문서

## 1. 프로젝트 개요

BLE LED Dongle과 Flutter 하이브리드 앱 간의 통신 프로토콜을 설계하여, JSON 기반으로 LED 패턴을 커스터마이징할 수 있는 시스템을 구축합니다.

### 1.1 하드웨어 사양
- **LED 매트릭스**: 12x12 (총 144개 LED)
- **LED 타입**: WS2812B (GRB 형식)
- **통신 방식**: BLE (Nordic UART Service)
- **펌웨어**: nRF52 SDK 기반

### 1.2 앱 플랫폼
- **프레임워크**: Flutter (하이브리드 앱)
- **플랫폼**: Android (우선), iOS (향후 확장 가능)

---

## 2. 통신 프로토콜 요구사항

### 2.1 프로토콜 형식
- **데이터 형식**: JSON
- **전송 방식**: BLE NUS (Nordic UART Service)를 통한 텍스트 기반 통신
- **인코딩**: UTF-8
- **패킷 분할**: BLE MTU 제한(기본 23바이트, 최대 247바이트) 고려하여 청크 단위 전송

### 2.2 지원 데이터 타입

#### 2.2.1 정적 이미지 (Static Image)
- **해상도**: 12x12 픽셀
- **색상 형식**: RGB (각 픽셀당 R, G, B 값 0-255)
- **데이터 크기**: 12 × 12 × 3 = 432 바이트 (압축 전)
- **표시 방식**: 즉시 표시 또는 저장 후 재생

#### 2.2.2 애니메이션 패턴 (Animation Pattern)
- **최대 길이**: 10초
- **프레임 레이트**: 권장 10-30 FPS (조정 가능)
- **프레임 수**: 최대 300 프레임 (10초 × 30 FPS)
- **데이터 크기**: 432 바이트 × 프레임 수
- **재생 모드**: 
  - 일회성 재생
  - 반복 재생
  - 역방향 재생
  - 양방향 재생 (왕복)

---

## 3. JSON 프로토콜 명세

**상세한 JSON 프로토콜 명세는 `PROTOCOL_JSON.md` 파일을 참조하세요.**

### 3.1 주요 명령어 요약

#### 3.1.1 정적 이미지 전송
- **형식 1 (권장)**: Base64 인코딩된 픽셀 데이터
- **형식 2**: JSON 배열 형식 (작은 이미지용)
- **형식 3**: 팔레트 기반 압축 형식

#### 3.1.2 애니메이션 패턴 전송
- **초기화**: `set_animation_init` - 애니메이션 메타데이터 설정
- **청크 전송**: `set_animation_chunk` - 프레임 데이터를 청크 단위로 전송
- **완료**: `set_animation_complete` - 전송 완료 확인

#### 3.1.3 제어 명령
- `play`, `pause`, `stop`, `reset` - 재생 제어
- `set_brightness` - 밝기 조절
- `get_status` - 상태 조회

#### 3.1.4 응답 형식
- `ack` - 성공 응답
- `error` - 에러 응답
- `progress` - 진행 상황 (대용량 전송 시)
- `status` - 상태 정보

**자세한 JSON 스키마 및 예제는 `PROTOCOL_JSON.md`와 `examples/json_examples/` 디렉토리를 참조하세요.**

---

## 4. Flutter 앱 요구사항

### 4.1 BLE 통신 모듈

#### 4.1.1 필수 기능
- **BLE 스캔**: 주변 BLE LED Dongle 디바이스 검색
- **BLE 연결**: 디바이스 연결/해제
- **데이터 전송**: JSON 명령 전송 (청크 분할 지원)
- **데이터 수신**: 디바이스 응답 수신 및 파싱
- **연결 상태 관리**: 연결 상태 모니터링 및 재연결 처리

#### 4.1.2 사용 라이브러리
- `flutter_blue_plus` 또는 `flutter_reactive_ble` (BLE 통신)
- `dart:convert` (JSON 인코딩/디코딩)
- `dart:typed_data` (바이너리 데이터 처리)

#### 4.1.3 구현 고려사항
- BLE MTU 크기 협상 (최대 247바이트)
- 전송 실패 시 재시도 로직
- 타임아웃 처리
- 백그라운드 전송 큐 관리

### 4.2 이미지 에디터 UI

#### 4.2.1 기본 기능
- **12x12 그리드 캔버스**: 터치/드래그로 픽셀 색상 지정
- **색상 선택기**: RGB 슬라이더 또는 컬러 피커
- **픽셀 단위 편집**: 개별 픽셀 선택 및 색상 변경
- **영역 선택**: 다중 픽셀 선택 및 일괄 편집
- **실시간 미리보기**: 편집 중인 이미지를 12x12 그리드로 표시

#### 4.2.2 고급 기능
- **도구**:
  - 펜 (개별 픽셀 그리기)
  - 브러시 (연속 그리기)
  - 지우개
  - 채우기 (영역 채우기)
  - 피커 (색상 추출)
- **편집 기능**:
  - 실행 취소/다시 실행
  - 전체 지우기
  - 그리드 표시/숨김
  - 줌 인/아웃
- **템플릿**: 미리 정의된 패턴 제공

#### 4.2.3 UI 컴포넌트
- `CustomPaint` 또는 `flutter_custom_paint` 사용
- `GestureDetector`로 터치 이벤트 처리
- `ColorPicker` 위젯 (예: `flutter_colorpicker`)

### 4.3 이미지 가져오기 기능

#### 4.3.1 이미지 소스
- **갤러리에서 선택**: `image_picker` 패키지 사용
- **카메라 촬영**: 실시간 촬영 및 편집
- **URL에서 다운로드**: 네트워크 이미지 로드

#### 4.3.2 이미지 처리
- **리사이즈**: 원본 이미지를 12x12로 다운스케일
- **리샘플링 알고리즘**: 
  - Nearest Neighbor (빠름)
  - Bilinear (품질 중간)
  - Bicubic (고품질, 느림)
- **색상 양자화**: RGB 값을 0-255 범위로 정규화
- **밝기/대비 조절**: 이미지 품질 향상

#### 4.3.3 사용 라이브러리
- `image_picker`: 갤러리/카메라 접근
- `image` (pub.dev): 이미지 리사이즈 및 처리
- `http`: URL 이미지 다운로드

### 4.4 애니메이션 에디터 UI

#### 4.4.1 기본 기능
- **타임라인**: 프레임별 편집 가능한 타임라인
- **프레임 편집**: 각 프레임을 이미지 에디터로 편집
- **프레임 추가/삭제**: 타임라인에서 프레임 관리
- **재생 컨트롤**: 재생/일시정지/정지, 프레임 단위 이동
- **프레임 레이트 설정**: FPS 조절 (10-30 FPS)

#### 4.4.2 고급 기능
- **프레임 복사/붙여넣기**: 프레임 간 복제
- **프레임 간 보간**: 자동 애니메이션 생성
- **온스크린 프리뷰**: 실시간 애니메이션 미리보기
- **프레임 지속 시간 조절**: 각 프레임의 duration_ms 설정

#### 4.4.3 UI 컴포넌트
- `flutter_animate` 또는 커스텀 애니메이션 위젯
- 타임라인 위젯 (커스텀 구현 또는 `timeline_tile` 활용)

### 4.5 비디오 처리 기능 (선택사항)

#### 4.5.1 비디오 소스
- **갤러리에서 선택**: 비디오 파일 선택
- **녹화**: 실시간 비디오 녹화

#### 4.5.2 비디오 처리
- **프레임 추출**: 비디오를 프레임 단위로 분할
- **리사이즈**: 각 프레임을 12x12로 다운스케일
- **프레임 레이트 조절**: 원본 FPS를 목표 FPS로 변환
- **최대 길이 제한**: 10초 초과 시 자동 자르기

#### 4.5.3 사용 라이브러리
- `video_player`: 비디오 재생 및 프레임 추출
- `ffmpeg_kit_flutter`: 고급 비디오 처리 (선택사항)

### 4.6 데이터 관리

#### 4.6.1 로컬 저장소
- **패턴 저장**: 생성한 이미지/애니메이션을 로컬에 저장
- **패턴 불러오기**: 저장된 패턴 목록 및 불러오기
- **패턴 삭제**: 저장된 패턴 삭제

#### 4.6.2 저장 형식
- JSON 파일로 저장 (압축 가능)
- SQLite 데이터베이스 (선택사항)
- SharedPreferences (간단한 설정)

#### 4.6.3 사용 라이브러리
- `shared_preferences`: 간단한 설정 저장
- `sqflite`: SQLite 데이터베이스 (선택사항)
- `path_provider`: 파일 경로 관리

### 4.7 UI/UX 요구사항

#### 4.7.1 화면 구성
1. **메인 화면**
   - BLE 디바이스 연결 상태 표시
   - 빠른 액션 버튼 (이미지 전송, 애니메이션 재생 등)
   - 저장된 패턴 목록

2. **이미지 에디터 화면**
   - 12x12 그리드 캔버스 (중앙)
   - 색상 선택기 (하단)
   - 도구 모음 (상단 또는 측면)
   - 미리보기 영역 (선택사항)

3. **애니메이션 에디터 화면**
   - 타임라인 (하단)
   - 현재 프레임 편집 영역 (중앙)
   - 재생 컨트롤 (상단)

4. **설정 화면**
   - 밝기 조절
   - 연결된 디바이스 정보
   - 앱 설정

#### 4.7.2 디자인 가이드라인
- Material Design 3 또는 Cupertino 디자인
- 다크 모드 지원
- 반응형 레이아웃 (다양한 화면 크기 지원)
- 직관적인 아이콘 및 버튼

---

## 5. 펌웨어 요구사항

### 5.1 JSON 파서
- 경량 JSON 파서 라이브러리 사용 (예: `cJSON`)
- 메모리 효율적인 파싱 (제한된 RAM 고려)
- 스트리밍 파싱 지원 (대용량 데이터용)

### 5.2 데이터 버퍼 관리
- **이미지 버퍼**: 432 바이트 (12×12×3)
- **애니메이션 버퍼**: 동적 할당 또는 고정 크기 버퍼
  - 최대 프레임 수 제한 (메모리 제약 고려)
  - 프레임별 버퍼 또는 전체 버퍼
- **전송 버퍼**: BLE 수신 데이터 임시 저장

### 5.3 애니메이션 재생 엔진
- **타이머 기반 재생**: `app_timer` 사용
- **프레임 관리**: 현재 프레임 인덱스 추적
- **재생 모드**: 일회성, 반복, 역방향, 양방향
- **부드러운 전환**: 프레임 간 전환 처리

### 5.4 에러 처리
- **JSON 파싱 에러**: 잘못된 형식 감지 및 에러 응답
- **메모리 부족**: 버퍼 오버플로우 방지
- **BLE 통신 에러**: 연결 끊김 처리
- **데이터 검증**: 픽셀 좌표 범위 검사, 색상 값 검증

### 5.5 최적화 고려사항
- **데이터 압축**: RLE 또는 간단한 압축 알고리즘 (선택사항)
- **전송 최적화**: 불필요한 데이터 제거
- **전력 관리**: LED 업데이트 빈도 조절

---

## 6. 구현 단계

### Phase 1: 기본 통신 프로토콜
1. JSON 프로토콜 정의 및 문서화
2. 펌웨어에 JSON 파서 통합
3. Flutter 앱에 BLE 통신 모듈 구현
4. 기본 명령어 테스트 (set_image, get_status)

### Phase 2: 이미지 에디터
1. 12x12 그리드 캔버스 구현
2. 색상 선택기 구현
3. 기본 편집 도구 구현
4. 이미지 가져오기 기능 구현
5. 이미지 전송 기능 구현

### Phase 3: 애니메이션 에디터
1. 타임라인 UI 구현
2. 프레임 편집 기능 구현
3. 애니메이션 재생 기능 구현
4. 애니메이션 전송 기능 구현 (청크 분할 포함)

### Phase 4: 고급 기능
1. 비디오 처리 기능 (선택사항)
2. 패턴 저장/불러오기
3. UI/UX 개선
4. 성능 최적화

### Phase 5: 테스트 및 최적화
1. 통합 테스트
2. 성능 테스트
3. 메모리 사용량 최적화
4. 사용자 테스트 및 피드백 반영

---

## 7. 기술 스택 요약

### 펌웨어
- **언어**: C
- **SDK**: nRF52 SDK
- **BLE**: Nordic UART Service (NUS)
- **JSON 파서**: cJSON 또는 유사 라이브러리

### Flutter 앱
- **프레임워크**: Flutter
- **언어**: Dart
- **BLE**: `flutter_blue_plus` 또는 `flutter_reactive_ble`
- **이미지 처리**: `image` 패키지
- **이미지 선택**: `image_picker`
- **비디오 처리**: `video_player` (선택사항)
- **로컬 저장소**: `shared_preferences`, `sqflite` (선택사항)

---

## 8. 제약사항 및 고려사항

### 8.1 BLE 통신 제약
- **MTU 크기**: 기본 23바이트, 최대 247바이트 (협상 필요)
- **전송 속도**: 약 1-2 KB/s (연결 품질에 따라 다름)
- **대용량 데이터**: 청크 분할 필수 (10초 애니메이션 ≈ 130KB)

### 8.2 메모리 제약
- **펌웨어 RAM**: 제한적 (nRF52 기준 약 64KB)
- **애니메이션 버퍼**: 프레임 수 제한 필요
- **스트리밍 처리**: 실시간 수신 및 재생 고려

### 8.3 성능 고려사항
- **LED 업데이트**: 50ms 간격 (현재 설정)
- **JSON 파싱**: CPU 사용량 최소화
- **앱 UI**: 60 FPS 유지

### 8.4 사용자 경험
- **전송 시간**: 대용량 애니메이션 전송 시 진행률 표시
- **에러 처리**: 명확한 에러 메시지 제공
- **오프라인 모드**: 디바이스 미연결 시에도 편집 가능

---

## 9. 참고 자료

### BLE 통신
- Nordic UART Service 문서
- BLE GATT 프로토콜 사양

### Flutter
- Flutter BLE 플러그인 문서
- Flutter 이미지 처리 가이드

### JSON 프로토콜
- JSON 표준 (RFC 8259)
- cJSON 라이브러리 문서

---

## 10. 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 1.0 | 2024-XX-XX | 초기 요구사항 문서 작성 | - |

---

**문서 작성일**: 2024년
**최종 수정일**: 2024년
