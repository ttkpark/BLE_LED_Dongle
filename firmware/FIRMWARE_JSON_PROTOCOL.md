# 펌웨어 JSON 프로토콜 구현 가이드

## 개요

BLE LED Dongle 펌웨어에 JSON 프로토콜 처리를 추가했습니다. Flutter 앱에서 보낸 JSON 명령을 처리하여 LED 매트릭스를 제어합니다.

## 추가된 파일

### 1. JSON 파서 (`json_parser.h`, `json_parser.c`)
- 경량 JSON 파서 구현
- 문자열, 정수, 불린 값 추출
- JSON 응답 생성

### 2. Base64 디코더 (`base64.h`, `base64.c`)
- Base64 인코딩된 픽셀 데이터 디코딩
- 메모리 효율적인 구현

### 3. JSON 프로토콜 핸들러 (`json_protocol.h`, `json_protocol.c`)
- JSON 명령 처리
- 이미지/애니메이션 데이터 관리
- LED 매트릭스 제어

## 지원하는 명령어

### 이미지 관련
- `set_image`: Base64 인코딩된 이미지 데이터 수신 및 표시

### 애니메이션 관련
- `set_animation_init`: 애니메이션 초기화
- `set_animation_chunk`: 애니메이션 프레임 청크 수신
- `set_animation_complete`: 애니메이션 전송 완료

### 제어 명령
- `play`: 애니메이션 재생
- `pause`: 애니메이션 일시정지
- `stop`: 애니메이션 정지
- `reset`: 리셋
- `set_brightness`: 밝기 조절
- `get_status`: 상태 조회

## 메모리 제약

- **최대 애니메이션 프레임 수**: 100 프레임 (메모리 제약)
- **프레임당 데이터 크기**: 432 바이트 (12×12×3)
- **총 애니메이션 버퍼**: 약 43KB

## 사용 방법

### 1. 빌드 설정

프로젝트에 다음 파일들을 추가해야 합니다:
- `json_parser.c`
- `json_parser.h`
- `base64.c`
- `base64.h`
- `json_protocol.c`
- `json_protocol.h`

### 2. 초기화

`main()` 함수에서 `json_protocol_init()`을 호출합니다.

### 3. 명령 처리

`ble_nus_cmd_received()` 함수가 JSON 명령을 자동으로 처리합니다.

## 애니메이션 타이밍

애니메이션 프레임 업데이트는 `animation_update()` 함수를 주기적으로 호출해야 합니다. 현재는 `idle_state_handle()`에서 LED 업데이트 타이머와 함께 처리됩니다.

더 정확한 타이밍이 필요한 경우, 별도의 `app_timer`를 사용하여 프레임 레이트에 맞춰 호출하는 것을 권장합니다.

## 디버깅

RTT 로그를 통해 JSON 명령 수신 및 처리 과정을 확인할 수 있습니다:
- 수신된 JSON 문자열
- 처리된 명령
- 에러 메시지

## 주의사항

1. **메모리 관리**: 애니메이션 프레임 수는 메모리 제약에 따라 조정해야 할 수 있습니다.
2. **타이밍**: 애니메이션 프레임 업데이트는 정확한 타이밍이 필요합니다.
3. **에러 처리**: 모든 명령에 대해 적절한 에러 응답을 전송합니다.

## 향후 개선 사항

1. 더 정확한 애니메이션 타이밍 (app_timer 사용)
2. 메모리 사용량 최적화
3. 추가 명령어 지원
4. 데이터 검증 강화
